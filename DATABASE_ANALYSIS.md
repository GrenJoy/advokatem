# üîç –ê–ù–ê–õ–ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–• –ò –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø

## üìä **–°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•:**

### **–¢–∞–±–ª–∏—Ü—ã —Å CASCADE DELETE:**
```sql
-- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–µ–ª–∞ (DELETE) —É–¥–∞–ª—è—é—Ç—Å—è:
- case_photos (—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏)
- photo_ocr_results (OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã) 
- photo_comments (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ñ–æ—Ç–æ)
- ai_chat_sessions (—Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞)
- ai_chat_messages (—Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞)
- case_context_cache (–∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
- case_additional_files (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)
```

### **–¢–∞–±–ª–∏—Ü—ã –ë–ï–ó CASCADE (–ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏):**
```sql
-- –ü—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏ (UPDATE status = 'archived') –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è:
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –±–∞–∑–µ
- –ü—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –¥–µ–ª–∞
- –í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, —Ñ–∞–π–ª—ã, —á–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
```

## ‚è∞ **–ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ö–°–¢–ê:**

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—ç—à:**
```javascript
// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (—Å–≤–µ–∂–∏–π –ª–∏?)
const cacheAge = Date.now() - new Date(cacheResult.rows[0].last_updated).getTime()
if (cacheAge < 3600000) { // 1 —á–∞—Å = 3600000 –º—Å
  return cacheResult.rows[0].context_data // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
}

// 2. –ï—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª - —Å—Ç—Ä–æ–∏–º –Ω–æ–≤—ã–π
const context = {
  case: caseResult.rows[0],
  photos: photosResult.rows,
  summary: { /* –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ */ }
}

// 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –∫—ç—à
INSERT INTO case_context_cache (case_id, context_data, last_updated)
VALUES ($1, $2, $3)
ON CONFLICT (case_id) DO UPDATE SET 
  context_data = $2, 
  last_updated = $3
```

### **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞:**
- ‚úÖ **1 —á–∞—Å** - –∫—ç—à —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–≤–µ–∂–∏–º
- ‚úÖ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ/—Ñ–∞–π–ª–æ–≤
- ‚úÖ **–£–º–Ω—ã–π –∫—ç—à** - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –¥–µ–ª–µ

## üí¨ **–°–ï–°–°–ò–ò –ò–ò-–ß–ê–¢–ê:**

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Å—Å–∏—è:**
```sql
-- –§—É–Ω–∫—Ü–∏—è get_or_create_active_session:
1. –ò—â–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –¥–µ–ª–∞
2. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID —Å–µ—Å—Å–∏–∏
```

### **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏:**
```sql
-- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ ai_chat_messages:
- session_id (—Å–≤—è–∑—å —Å —Å–µ—Å—Å–∏–µ–π)
- case_id (—Å–≤—è–∑—å —Å –¥–µ–ª–æ–º) 
- message_type ('user', 'ai', 'system')
- message_text (—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è)
- context_used (–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å)
- created_at (–≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è)
```

### **–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏:**
```javascript
// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
SELECT message_type, message_text, created_at
FROM ai_chat_messages 
WHERE session_id = $1 
ORDER BY created_at DESC 
LIMIT 10
```

## üîÑ **–ß–¢–û –ü–†–û–ò–°–•–û–î–ò–¢ –ß–ï–†–ï–ó –î–ï–ù–¨:**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–µ–ª–æ –ù–ï –∏–∑–º–µ–Ω—è–ª–æ—Å—å**
```javascript
// 1. –ö—ç—à —É—Å—Ç–∞—Ä–µ–ª (>1 —á–∞—Å–∞)
// 2. –°—Ç—Ä–æ–∏—Ç—Å—è –Ω–æ–≤—ã–π –∫—ç—à –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
// 3. –ò–ò –ø–æ–ª—É—á–∞–µ—Ç –ü–û–õ–ù–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç:
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ª–µ
- –í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å OCR
- –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç—ã, –∏–º–µ–Ω–∞, —Å—É–º–º—ã)
- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –î–µ–ª–æ –∏–∑–º–µ–Ω—è–ª–æ—Å—å**
```javascript
// 1. –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
// 2. –°—Ç—Ä–æ–∏—Ç—Å—è —Å–≤–µ–∂–∏–π –∫—ç—à
// 3. –ò–ò –ø–æ–ª—É—á–∞–µ—Ç –ê–ö–¢–£–ê–õ–¨–ù–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç
```

## üóÇÔ∏è **–ê–†–•–ò–í–ò–†–û–í–ê–ù–ò–ï VS –£–î–ê–õ–ï–ù–ò–ï:**

### **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ (status = 'archived'):**
```sql
-- –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
UPDATE cases SET status = 'archived' WHERE id = ?

-- –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:
‚úÖ –í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
‚úÖ –í—Å–µ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã  
‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã
‚úÖ –í—Å—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
‚úÖ –í–µ—Å—å –∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚úÖ –í—Å–µ —Å–µ—Å—Å–∏–∏

-- –ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è:
‚ùå –î–µ–ª–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–ø–∏—Å–∫–µ
‚ùå –ü–æ–∏—Å–∫ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –¥–µ–ª–æ
‚ùå –ù—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ê—Ä—Ö–∏–≤" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
```

### **–£–¥–∞–ª–µ–Ω–∏–µ (DELETE):**
```sql
-- –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
DELETE FROM cases WHERE id = ?

-- –ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è (CASCADE):
‚ùå –í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
‚ùå –í—Å–µ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
‚ùå –í—Å–µ —Ñ–∞–π–ª—ã  
‚ùå –í—Å—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
‚ùå –í–µ—Å—å –∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚ùå –í—Å–µ —Å–µ—Å—Å–∏–∏

-- –ß—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è:
‚úÖ –ù–∏—á–µ–≥–æ (–ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)
```

## üéØ **–û–¢–í–ï–¢–´ –ù–ê –í–û–ü–†–û–°–´:**

### **1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–∏ –∫—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –¥–µ–Ω—å?**
- ‚úÖ **–î–ê** - –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ
- ‚úÖ **–ö—ç—à –æ–±–Ω–æ–≤–∏—Ç—Å—è** - —á–µ—Ä–µ–∑ —á–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—Å—è
- ‚úÖ **–ò–ò —É–≤–∏–¥–∏—Ç –≤—Å–µ** - –ø–æ–ª—É—á–∏—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏

### **2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–∏ —á–∞—Ç —Å –ò–ò?**
- ‚úÖ **–î–ê** - –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `ai_chat_messages`
- ‚úÖ **–°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞** - `get_or_create_active_session` –Ω–∞–π–¥–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—Å—Ç —Å–µ—Å—Å–∏—é
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ò–ò

### **3. –ß—Ç–æ –ø–æ–ª—É—á–∏—Ç –ò–ò –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å?**
```javascript
// –ò–ò –ø–æ–ª—É—á–∏—Ç –ü–û–õ–ù–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç:
{
  case: { /* –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ª–µ */ },
  photos: [ /* –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å OCR */ ],
  summary: { /* –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ */ },
  history: [ /* –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ */ ]
}
```

### **4. –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Å–µ—Å—Å–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ?**
- ‚úÖ **–î–ê** - —Å–µ—Å—Å–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥–µ–ª—É
- ‚úÖ **–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è** - –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏
- ‚úÖ **–£–º–Ω–∞—è** - —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### **5. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏?**
- **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –¥–µ–ª–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- **–£–¥–∞–ª–µ–Ω–∏–µ:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞ (CASCADE)

## üöÄ **–í–´–í–û–î–´:**

### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:**
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º (1 —á–∞—Å –∫—ç—à–∞)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ Gemini API

### **–°–µ—Å—Å–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–¥–µ–∂–Ω–æ:**
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞
- ‚úÖ –ò–ò –ø–æ–º–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
- ‚úÖ –£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

### **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ:**
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–ª–æ
- ‚úÖ –ù–∏—á–µ–≥–æ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è

**–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ!** üéâ
